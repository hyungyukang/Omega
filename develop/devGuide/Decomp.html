<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Domain Decomposition (Decomp)</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Parallel IO (IO)" href="IO.html" />
    <link rel="prev" title="Developing Omega Logging" href="Logging.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            OMEGA
          </a>
              <div class="version">
                develop
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/QuickStart.html">Quick Start for Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/OmegaBuild.html">CMake-based Omega Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/DataTypes.html">Data Types and Precision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/MachEnv.html">Machine Environment (MachEnv)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Config.html">Model Configuration (Config)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Broadcast.html">Omega Broadcast</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Logging.html">Omega Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Decomp.html">Domain Decomposition (Decomp)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/IO.html">Parallel IO (IO)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Halo.html">Halo Exchanges (Halo)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/HorzMesh.html">Horizontal Mesh</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer's guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="QuickStart.html">Quick Start for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="DataTypes.html">Data Types and Precision</a></li>
<li class="toctree-l1"><a class="reference internal" href="DataTypes.html#arrays-and-yakl">Arrays and YAKL</a></li>
<li class="toctree-l1"><a class="reference internal" href="MachEnv.html">Machine Environment (MachEnv)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Config.html">Model Configuration (Config)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Broadcast.html">Omega Broadcast</a></li>
<li class="toctree-l1"><a class="reference internal" href="CondaEnv.html">Development Conda Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="Linting.html">Linting Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="Docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildDocs.html">Building the Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="CMakeBuild.html">Omega Build with CMake</a></li>
<li class="toctree-l1"><a class="reference internal" href="Logging.html">Developing Omega Logging</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Domain Decomposition (Decomp)</a></li>
<li class="toctree-l1"><a class="reference internal" href="IO.html">Parallel IO (IO)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Halo.html">Halo Exchanges (Halo)</a></li>
<li class="toctree-l1"><a class="reference internal" href="HorzMesh.html">Horizontal Mesh</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Design documents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../design/Broadcast.html">Broadcast</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/Config.html">Config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/DataTypes.html">DataTypes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/Decomp.html">Decomp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/Halo.html">Halo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/Logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/MachEnv.html">MachineEnv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/Metadata.html">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/IO.html">Input/Output (IO)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/IOStreams.html">IOStreams</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/Reductions.html">Global Reductions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/ShallowWaterOmega0.html">Omega v0: Shallow Water</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/TimeMgr.html">TimeManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/HorzMeshClass.html">Horizontal Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/OmegaDesignTemplate.html">Template: MyClassOrModuleName</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OMEGA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Domain Decomposition (Decomp)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/devGuide/Decomp.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="domain-decomposition-decomp">
<h1>Domain Decomposition (Decomp)<a class="headerlink" href="#domain-decomposition-decomp" title="Permalink to this heading">ÔÉÅ</a></h1>
<p>In order to run across nodes in a parallel computer, OMEGA subdivides the
horizontal domain into subdomains that are distributed across the machine
and communicate using message passing via the Message Passing Interface (MPI).
To decompose the domain, we utilize the
<a class="reference external" href="http://glaros.dtc.umn.edu/gkhome/metis/metis/overview">METIS</a> library.
An OMEGA mesh is fully described by the
<a class="reference external" href="https://mpas-dev.github.io/files/documents/MPAS-MeshSpec.pdf">MPAS Mesh Specification</a>
which we will reproduce here eventually. The Decomp class decomposes
the domain based on the index space and number of MPI tasks (currently
one subdomain per task). Once decomposed, the Decomp class holds all
of the index space information as described below.</p>
<p>Within OMEGA, a default decomposition of the mesh is first created
with the call:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">Decomp</span><span class="o">::</span><span class="n">init</span><span class="p">();</span>
</pre></div>
</div>
<p>This must be called very early in the init process, just after initializing
the MachEnv, Config and IO.  Mesh information is first read using parallel
IO into an equally-spaced linear decomposition, then partitioned by METIS
into a more optimal decomposition. The parallel METIS implementation
(ParMETIS) will eventually be used to reduce the memory footprint for
high-resolution configurations, but currently we use the serial METIS library
for the partitioning.</p>
<p>METIS requires information about the connectivity in the mesh. In particular,
it needs the total number of cells and edges in the mesh and the connectivity
given by the CellsOnCell array that stores the indices of neighboring cells
for each cell. Once the cells have been partitioned, we determine multiple
layers of halo cells that will be needed to avoid excessive communcation with
remote neighboring subdomains. The CellsOnCell, EdgesOnCell
and VerticesOnCell arrays are then distributed according to this cell
partitioning. Edges and Vertices are then partitioned. Ownership of each
edge/vertex is determined by the first (valid) cell index in the CellsOnEdge
or CellsOnVertex for that edge/vertex. The remaining connectivity arrays
(CellsOnEdge, EdgesOnEdge, VerticesOnEdge, CellsOnVertex, EdgesOnVertex)
are the redistributed to match the edge and vertex distributions. Halos
are filled to ensure all necessary edge and vertex information for the
cell decomposition (and cell halos) are present in the subdomain.</p>
<p>After the call to the Decomp initialization routine, a Decomp named
Default has been created and can be retrieved with</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">OMEGA</span><span class="o">::</span><span class="n">Decomp</span><span class="w"> </span><span class="o">*</span><span class="n">DefDecomp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OMEGA</span><span class="o">::</span><span class="n">Decomp</span><span class="o">::</span><span class="n">getDefault</span><span class="p">();</span>
</pre></div>
</div>
<p>Once retrieved all Decomp members are public and can be accessed using</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">OMEGA</span><span class="o">::</span><span class="n">I4</span><span class="w"> </span><span class="n">NCells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DefDecomp</span><span class="o">-&gt;</span><span class="n">NCells</span><span class="p">;</span>
<span class="n">OMEGA</span><span class="o">::</span><span class="n">ArrayHost1DI4</span><span class="w"> </span><span class="n">CellIDH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DefDecomp</span><span class="o">-&gt;</span><span class="n">CellIDH</span><span class="p">;</span>
</pre></div>
</div>
<p>Decomp is a container for all mesh index and connectivity arrays as
described in the mesh specification above. In particular, it contains</p>
<ul class="simple">
<li><p>NCellsGlobal: the total number of cells</p></li>
<li><p>NCellsAll: the total number of cells in the local partition</p></li>
<li><p>NCellsSize: the length of the Cell array axis (typicall NCellsAll+1)</p></li>
<li><p>NCellsOwned: the number of cells owned by this task</p></li>
<li><p>NCellsHalo(i): the number of owned+halo cells for each halo layer</p></li>
<li><p>Analogous size variables for Edges and Vertices</p></li>
<li><p>MaxEdges: the max number of edges on a cell (and array size)</p></li>
<li><p>VertexDegree: the number of cells/edges at each vertex</p></li>
<li><p>CellID(NCellsSize): the global index for each local cell</p></li>
<li><p>CellLoc(NCellsSize,2): the task and local index for every local cell
(redundant for owned cells but gives the remote location for halo cells)</p></li>
<li><p>Analogous arrays for Edges, Vertices</p></li>
<li><p>CellsOnCell(NCellsSize,MaxEdges): the local index for neighbor cells
across each cell edge</p></li>
<li><p>EdgesOnCell(NCellsSize,MaxEdges): the local edge index for each cell edge</p></li>
<li><p>VerticesOnCell(NCellsSize,MaxEdges): the local index for each cell vertex</p></li>
<li><p>CellsOnEdge(NEdgesSize,2): the index of the 2 cells sharing an edge</p></li>
<li><p>VerticesOnEdge(NEdgesSize,2): the vertex index at each edge endpoint</p></li>
<li><p>EdgesOnEdge(NEdgesSize,MaxEdges x 2): the index for all edges contributing
to an edge (all edges of the 2 cells sharing an edge)</p></li>
<li><p>CellsOnVertex(NVerticesSize,VertexDegree): indices for all cells meeting
at a vertex</p></li>
<li><p>EdgesOnVertex(NVerticesSize,VertexDegree): indices for all edges meeting
at a vertex</p></li>
<li><p>NEdgesOnCell(NCellsSize): the number of actual edges on each cell</p></li>
<li><p>NEdgesOnEdge(NEdgesSize): the number of actual edges on each edge</p></li>
</ul>
<p>For each of the arrays above, there is a copy of the array on the host and
device (GPU) with the host array named with an extra H on the end
(eg CellsOnCellH). All are YAKL arrays so are accessed with (index) rather
than [index] and for some of the arrays noted above are multi-dimensional.
A typical host loop might then look something like:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">Cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">Cell</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NCellsOwned</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">Cell</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">Edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">Edge</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NEdgesOnCell</span><span class="p">(</span><span class="n">Cell</span><span class="p">);</span><span class="w"> </span><span class="o">++</span><span class="n">Edge</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">VarH</span><span class="p">(</span><span class="n">Cell</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VarH</span><span class="p">(</span><span class="n">Cell</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">FluxH</span><span class="p">(</span><span class="n">Cell</span><span class="p">,</span><span class="n">Edge</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And on the device, we use the YAKL form (note that we will likely create
aliases for extended yakl expressions, like parallel_for to replace
yakl::c::parallel_for);</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">yakl</span><span class="o">::</span><span class="n">c</span><span class="o">::</span><span class="n">parallel_for</span><span class="p">(</span><span class="w"> </span><span class="n">yakl</span><span class="o">::</span><span class="n">c</span><span class="o">::</span><span class="n">Bounds</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">NCellsOwned</span><span class="p">,</span><span class="n">MaxEdges</span><span class="p">),</span>
<span class="w">                       </span><span class="n">YAKL_LAMBDA</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">Cell</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Edge</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Edge</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NEdgesOnCell</span><span class="p">(</span><span class="n">Cell</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">Var</span><span class="p">(</span><span class="n">Cell</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Var</span><span class="p">(</span><span class="n">Cell</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Flux</span><span class="p">(</span><span class="n">Cell</span><span class="p">,</span><span class="n">Edge</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Any defined decomposition can be removed by name using</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">Decomp</span><span class="o">::</span><span class="n">erase</span><span class="p">(</span><span class="n">Name</span><span class="p">);</span>
</pre></div>
</div>
<p>and all decompositions <em>must</em> be removed before the yakl finalize call using</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">Decomp</span><span class="o">::</span><span class="n">clear</span><span class="p">();</span>
</pre></div>
</div>
<p>which destroys all host and device arrays before YAKL finalizes and removes
the memory pool in which all the arrays are allocated. Failure to call clear
before <code class="docutils literal notranslate"><span class="pre">yakl::finalize()</span></code> will result in an error.</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Logging.html" class="btn btn-neutral float-left" title="Developing Omega Logging" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="IO.html" class="btn btn-neutral float-right" title="Parallel IO (IO)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Energy Exascale Earth System Model Project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>