<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Input/Output (IO)</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="IOStreams" href="IOStreams.html" />
    <link rel="prev" title="Metadata" href="Metadata.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            OMEGA
          </a>
              <div class="version">
                develop
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/QuickStart.html">Quick Start for Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/OmegaBuild.html">CMake-based Omega Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/DataTypes.html">Data Types and Precision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/MachEnv.html">Machine Environment (MachEnv)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Logging.html">Omega Logging</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/QuickStart.html">Quick Start for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/DataTypes.html">Data Types and Precision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/DataTypes.html#arrays-and-yakl">Arrays and YAKL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/MachEnv.html">Machine Environment (MachEnv)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/CondaEnv.html">Development Conda Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/BuildDocs.html">Building the Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/CMakeBuild.html">Omega Build with CMake</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Logging.html">Developing Omega Logging</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Design documents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Broadcast.html">Broadcast</a></li>
<li class="toctree-l1"><a class="reference internal" href="Config.html">Config</a></li>
<li class="toctree-l1"><a class="reference internal" href="DataTypes.html">DataTypes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Decomp.html">Decomp</a></li>
<li class="toctree-l1"><a class="reference internal" href="Halo.html">Halo</a></li>
<li class="toctree-l1"><a class="reference internal" href="Logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="MachEnv.html">MachineEnv</a></li>
<li class="toctree-l1"><a class="reference internal" href="Metadata.html">Metadata</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Input/Output (IO)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">1 Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#requirements">2 Requirements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#requirement-read-fields-and-metadata">2.1 Requirement: Read fields and metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requirement-write-fields-and-metadata">2.2 Requirement: Write fields and metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requirement-self-describing-formats">2.3 Requirement: Self-describing formats</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requirement-multiple-files-streams">2.4 Requirement: multiple files/streams</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requirement-parallel-i-o">2.5 Requirement: parallel I/O</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requirement-parallel-i-o-tuning">2.6 Requirement: parallel I/O tuning</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requirement-data-types-and-type-conversion">2.7 Requirement: Data types and type conversion</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requirement-yakl-arrays-and-host-device-support">2.8 Requirement: YAKL arrays and host/device support</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requirement-modes-on-file-existence">2.9 Requirement: Modes on file existence</a></li>
<li class="toctree-l3"><a class="reference internal" href="#desired-asynchronous-i-o">2.10 Desired: Asynchronous I/O</a></li>
<li class="toctree-l3"><a class="reference internal" href="#desired-file-compression">2.11 Desired: File compression</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#algorithmic-formulation">3 Algorithmic Formulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#design">4 Design</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#data-types-and-parameters">4.1 Data types and parameters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#parameters">4.1.1 Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#class-structs-data-types">4.1.2 Class/structs/data types</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#methods">4.2 Methods</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#environment-constructor">4.2.1 Environment constructor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#file-open-close">4.2.2 File open/close</a></li>
<li class="toctree-l4"><a class="reference internal" href="#write-operations">4.2.3 Write operations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#read-operations">4.2.4 Read operations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#defining-io-fields">4.2.5 Defining IO fields</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#verification-and-testing">5 Verification and Testing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#test-via-iostreams">5.1 Test via IOStreams</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="IOStreams.html">IOStreams</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reductions.html">Global Reductions</a></li>
<li class="toctree-l1"><a class="reference internal" href="ShallowWaterOmega0.html">Omega v0: Shallow Water</a></li>
<li class="toctree-l1"><a class="reference internal" href="TimeMgr.html">TimeManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="OmegaDesignTemplate.html">Template: MyClassOrModuleName</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OMEGA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Input/Output (IO)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/design/IO.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="input-output-io">
<span id="omega-design-io"></span><h1>Input/Output (IO)<a class="headerlink" href="#input-output-io" title="Permalink to this heading"></a></h1>
<section id="overview">
<h2>1 Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h2>
<p>The OMEGA model must be able to read and write data to a filesystem.
For performance at high resolution, much of this IO must occur in parallel
and interact with a high-performance filesystem. We describe here an IO
layer that provides interfaces to the underlying SCORPIO parallel I/O
library used in E3SM. It primarily provides a translation layer to
read/write OMEGA metadata and YAKL arrays. It works together with the
OMEGA Metadata and IOStreams capabilities. Users will interact with
IO primarily through the IOStreams and should not need to access this
layer directly.</p>
</section>
<section id="requirements">
<h2>2 Requirements<a class="headerlink" href="#requirements" title="Permalink to this heading"></a></h2>
<section id="requirement-read-fields-and-metadata">
<h3>2.1 Requirement: Read fields and metadata<a class="headerlink" href="#requirement-read-fields-and-metadata" title="Permalink to this heading"></a></h3>
<p>The model must be able to read desired data and metadata from
an input file into the internal model storage/decomposition.
Metadata requirements are described in the Metadata design document.</p>
</section>
<section id="requirement-write-fields-and-metadata">
<h3>2.2 Requirement: Write fields and metadata<a class="headerlink" href="#requirement-write-fields-and-metadata" title="Permalink to this heading"></a></h3>
<p>The model must be able to write desired data and metadata
to an output file for later use. Metadata requirements are
described in the Metadata design document.</p>
</section>
<section id="requirement-self-describing-formats">
<h3>2.3 Requirement: Self-describing formats<a class="headerlink" href="#requirement-self-describing-formats" title="Permalink to this heading"></a></h3>
<p>All files must (eventually) be in a self-describing
format like HDF5 or netCDF. Note that alternative formats
can be supported as long as scripts are provided to convert
to netCDF/HDF5 efficiently as part of model run scripts.
SCORPIO supports a number of underlying formats and the
user must be able to select the appropriate format (eg
multiple netcdf formats and ADIOS format).</p>
</section>
<section id="requirement-multiple-files-streams">
<h3>2.4 Requirement: multiple files/streams<a class="headerlink" href="#requirement-multiple-files-streams" title="Permalink to this heading"></a></h3>
<p>The model must support reading from and writing to an
arbitrary number of files with different properties
(eg precision, time frequencies, contents). There will
be a Streams capability described in a separate
design document that will manage many of these properties,
but the underlying I/O layer here must be able to
support multiple open files, each with unique
properties.</p>
</section>
<section id="requirement-parallel-i-o">
<h3>2.5 Requirement: parallel I/O<a class="headerlink" href="#requirement-parallel-i-o" title="Permalink to this heading"></a></h3>
<p>Performance at high resolution requires a parallel I/O
solution in which multiple processors can be writing/reading
data to maximize bandwidth to the filesystem and minimize
time spent in I/O.</p>
</section>
<section id="requirement-parallel-i-o-tuning">
<h3>2.6 Requirement: parallel I/O tuning<a class="headerlink" href="#requirement-parallel-i-o-tuning" title="Permalink to this heading"></a></h3>
<p>Some properties of the parallel I/O must be configurable
to tune the parallel I/O for performance on a particular
architecture and filesystem. At a minimum, the user must
be able to specify the number of I/O tasks and the stride
of those tasks.</p>
</section>
<section id="requirement-data-types-and-type-conversion">
<h3>2.7 Requirement: Data types and type conversion<a class="headerlink" href="#requirement-data-types-and-type-conversion" title="Permalink to this heading"></a></h3>
<p>The I/O system must be able to read/write all supported
data types for metadata and all supported YAKL array types.
In some cases, output files at reduced precision are required
so an option to convert data to reduced precision is needed.</p>
</section>
<section id="requirement-yakl-arrays-and-host-device-support">
<h3>2.8 Requirement: YAKL arrays and host/device support<a class="headerlink" href="#requirement-yakl-arrays-and-host-device-support" title="Permalink to this heading"></a></h3>
<p>Distributed data in OMEGA is stored as YAKL array types.
We must be able to read/write YAKL arrays and be able
to move data between host and device as needed.</p>
</section>
<section id="requirement-modes-on-file-existence">
<h3>2.9 Requirement: Modes on file existence<a class="headerlink" href="#requirement-modes-on-file-existence" title="Permalink to this heading"></a></h3>
<p>If an output file exists, the user must be able to specify
whether the model should overwrite the existing file, exit
with an error message or append data to the existing file.
On input, if a file does not exist, the model must exit with
an appropriate error code.</p>
</section>
<section id="desired-asynchronous-i-o">
<h3>2.10 Desired: Asynchronous I/O<a class="headerlink" href="#desired-asynchronous-i-o" title="Permalink to this heading"></a></h3>
<p>For performance, it would be desireable to enable the model
to launch I/O tasks and resume computation while the actual
writing to file takes place. This will mask I/O costs by
overlapping I/O functions with model computations.</p>
</section>
<section id="desired-file-compression">
<h3>2.11 Desired: File compression<a class="headerlink" href="#desired-file-compression" title="Permalink to this heading"></a></h3>
<p>It may be desireable to apply data compression while
performing I/O to minimize data file sizes. This compression
may be lossless or not depending on the use for each
file.</p>
</section>
</section>
<section id="algorithmic-formulation">
<h2>3 Algorithmic Formulation<a class="headerlink" href="#algorithmic-formulation" title="Permalink to this heading"></a></h2>
<p>Parallel I/O systems use various algorithms for rearranging
data in parallel decompositions to the decomposition required
for the I/O processor layout. These algorithms are described
in the I/O library (scorpio) documentation and related
publications.</p>
</section>
<section id="design">
<h2>4 Design<a class="headerlink" href="#design" title="Permalink to this heading"></a></h2>
<p>The OMEGA model I/O will be built on top of the SCORPIO
parallel I/O library used across E3SM components. The
I/O interfaces here generally provide wrappers for
translating internal OMEGA metadata representations and
YAKL array types to the form required by SCORPIO. OMEGA
users and developers will generally interact with I/O
through the IO Streams layer that manages all files and
associated file contents.</p>
<section id="data-types-and-parameters">
<h3>4.1 Data types and parameters<a class="headerlink" href="#data-types-and-parameters" title="Permalink to this heading"></a></h3>
<section id="parameters">
<h4>4.1.1 Parameters<a class="headerlink" href="#parameters" title="Permalink to this heading"></a></h4>
<p>There will be a section in the input OMEGA configuration file
for managing overall parallel IO options. Currently, this
will include three variables:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="nt">IO</span><span class="p">:</span>
<span class="w">       </span><span class="nt">ioTasks</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">       </span><span class="nt">ioStride</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">       </span><span class="nt">ioRearranger</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">box</span>
</pre></div>
</div>
<p>The default for IO tasks and stride will be 1 for safety, but
should always be changed to appropriate values for a particular
simulation and machine architecture. For example, the user
should set the stride such that the number of cores performing
I/O is limited to the optimal number for a given multi-processor
node. Scorpio supports a few rearranger methods for moving the
data to IO tasks (see Scorpio documentation) but the box
rearranger is often preferred and is the default. The rearranger
is ignored for the ADIOS back-end since it writes separate files
from each task and rearranges the data in a post-processing step.
These input variables correspond to variables of the
same name.</p>
<p>We define a number of enums to support various options, including
the rearranger method, file format, operation (read/write) and
behavior when file exists:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">IORearranger</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">box</span><span class="p">,</span><span class="w">    </span><span class="c1">/// box rearranger (default)</span>
<span class="w">      </span><span class="n">subset</span><span class="p">,</span><span class="w"> </span><span class="c1">/// subset rearranger</span>
<span class="w">      </span><span class="n">unknown</span><span class="w"> </span><span class="c1">/// unknown or undefined</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">   </span><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">IOFileFormat</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="k">default</span><span class="p">,</span>
<span class="w">      </span><span class="n">netcdf</span><span class="p">,</span>
<span class="w">      </span><span class="n">pnetcdf</span><span class="p">,</span>
<span class="w">      </span><span class="n">netcdf4</span><span class="p">,</span>
<span class="w">      </span><span class="n">pnetcdf5</span><span class="p">,</span>
<span class="w">      </span><span class="n">hdf5</span><span class="p">,</span>
<span class="w">      </span><span class="n">adios</span><span class="p">,</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">   </span><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">IOMode</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">read</span><span class="p">,</span>
<span class="w">      </span><span class="n">write</span><span class="p">,</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">   </span><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">IOIfExists</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">overwrite</span><span class="p">,</span>
<span class="w">      </span><span class="n">fail</span><span class="p">,</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">   </span><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">IOPrecision</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">single</span><span class="p">,</span>
<span class="w">      </span><span class="kt">double</span><span class="p">,</span>
<span class="w">      </span><span class="p">};</span>
</pre></div>
</div>
</section>
<section id="class-structs-data-types">
<h4>4.1.2 Class/structs/data types<a class="headerlink" href="#class-structs-data-types" title="Permalink to this heading"></a></h4>
<p>The PIO routines require some information about the decomposition,
so there will be one class containing environment information including
array decompositions for each data type, mesh location and array size.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="k">class</span><span class="w"> </span><span class="nc">IOEnv</span><span class="w"> </span><span class="p">{</span>

<span class="w">      </span><span class="k">private</span><span class="o">:</span>

<span class="w">         </span><span class="c1">/// track and store all defined environments internally</span>
<span class="w">         </span><span class="k">static</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">IOEnv</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">definedEnvs</span><span class="p">;</span>

<span class="w">         </span><span class="c1">/// name for this environment</span>
<span class="w">         </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>

<span class="w">         </span><span class="c1">/// default file format and rearranger method</span>
<span class="w">         </span><span class="n">IOFormat</span><span class="w"> </span><span class="n">format</span><span class="p">;</span>
<span class="w">         </span><span class="n">IORearranger</span><span class="w"> </span><span class="n">rearranger</span><span class="p">;</span>

<span class="w">         </span><span class="c1">/// ptr to defined Scorpio IO system with MPI communicator info </span>
<span class="w">         </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">iosystem</span><span class="p">;</span>

<span class="w">         </span><span class="c1">/// pointers to defined decompositions for every multi-dim</span>
<span class="w">         </span><span class="c1">/// array, data type and cell location</span>
<span class="w">         </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">decompCell1DI4</span><span class="p">;</span>
<span class="w">         </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">decompCell1DR4</span><span class="p">;</span>
<span class="w">         </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">decompCell1DR8</span><span class="p">;</span>
<span class="w">         </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">decompCell2DI4</span><span class="p">;</span>
<span class="w">         </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">decompCell2DR4</span><span class="p">;</span>
<span class="w">         </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">decompCell2DR8</span><span class="p">;</span>
<span class="w">         </span><span class="c1">// continue for dimensions up to 5 and edge, vertex</span>
<span class="w">         </span><span class="c1">//   mesh locations</span>
<span class="w">         </span><span class="c1">// note that Scorpio does not support logical arrays</span>
<span class="w">         </span><span class="c1">//   or I8 types so these will be converted to an</span>
<span class="w">         </span><span class="c1">//   an appropriate type during read/write</span>

<span class="w">         </span><span class="c1">// Methods below will be private and only accessed</span>
<span class="w">         </span><span class="c1">// via the OMEGA IOstreams interfaces with IOstreams</span>
<span class="w">         </span><span class="c1">// as a friend class</span>

<span class="w">      </span><span class="k">public</span><span class="o">:</span>
<span class="w">         </span><span class="c1">// Users will not access methods or vars directly</span>
<span class="w">         </span><span class="c1">// but only through the IOstreams interfaces</span>

<span class="w">      </span><span class="k">friend</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">IOStreams</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
</pre></div>
</div>
<p>There will also be an IOField class to combine the Metadata
and a pointer to the array holding data. This will be used
to specify the fields in an IOStream.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="k">class</span><span class="w"> </span><span class="nc">IOField</span><span class="w"> </span><span class="p">{</span>

<span class="w">      </span><span class="k">private</span><span class="o">:</span>

<span class="w">         </span><span class="c1">/// track and store all defined fields internally</span>
<span class="w">         </span><span class="k">static</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">IOField</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">definedFields</span><span class="p">;</span>

<span class="w">         </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Metadata</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metaPtr</span><span class="p">;</span>

<span class="w">         </span><span class="c1">/// only one of the pointers will be defined based on array type</span>
<span class="w">         </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Array1DI4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data1DI4</span><span class="p">;</span>
<span class="w">         </span><span class="p">[</span><span class="n">replicated</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">5</span><span class="n">D</span><span class="w"> </span><span class="n">arrays</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">I4</span><span class="p">,</span><span class="n">I8</span><span class="p">,</span><span class="n">R4</span><span class="p">,</span><span class="n">R8</span><span class="p">]</span>
<span class="w">         </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ArrayHost1DI4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dataHost1DI4</span><span class="p">;</span>
<span class="w">         </span><span class="p">[</span><span class="n">replicated</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">5</span><span class="n">D</span><span class="w"> </span><span class="n">arrays</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">I4</span><span class="p">,</span><span class="n">I8</span><span class="p">,</span><span class="n">R4</span><span class="p">,</span><span class="n">R8</span><span class="p">]</span>


<span class="w">      </span><span class="k">public</span><span class="o">:</span>
<span class="w">         </span><span class="c1">// See methods below</span>

<span class="w">      </span><span class="k">friend</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">IOStreams</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="methods">
<h3>4.2 Methods<a class="headerlink" href="#methods" title="Permalink to this heading"></a></h3>
<p>As noted above, these methods are actually private and accessed
only through the IOStreams interfaces.</p>
<section id="environment-constructor">
<h4>4.2.1 Environment constructor<a class="headerlink" href="#environment-constructor" title="Permalink to this heading"></a></h4>
<p>There will be a constructor that initializes the IO system
and decompositions. Note that the defaults for file format
and rearranger can be overridden on a per-file basis.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="n">IOEnv</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="c1">/// name for this env</span>
<span class="w">         </span><span class="k">const</span><span class="w"> </span><span class="n">MachEnv</span><span class="w"> </span><span class="n">omegaEnv</span><span class="p">,</span><span class="w"> </span><span class="c1">/// machine env with MPI info</span>
<span class="w">         </span><span class="k">const</span><span class="w"> </span><span class="n">Decomp</span><span class="w">  </span><span class="n">omegaDecomp</span><span class="p">,</span><span class="w"> </span><span class="c1">/// mesh decomposition</span>
<span class="w">         </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ioTasks</span><span class="p">,</span><span class="w">      </span><span class="c1">/// number of IO tasks</span>
<span class="w">         </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ioStride</span><span class="p">,</span><span class="w">     </span><span class="c1">/// stride in MPI ranks for io tasks</span>
<span class="w">         </span><span class="k">const</span><span class="w"> </span><span class="n">IOFormat</span><span class="w"> </span><span class="n">format</span><span class="p">,</span><span class="w">  </span><span class="c1">/// default IO format</span>
<span class="w">         </span><span class="k">const</span><span class="w"> </span><span class="n">IORearranger</span><span class="w"> </span><span class="n">rearranger</span><span class="p">,</span><span class="w"> </span><span class="c1">/// default rearranger method</span>
<span class="w">         </span><span class="p">);</span><span class="w"> </span>
</pre></div>
</div>
</section>
<section id="file-open-close">
<h4>4.2.2 File open/close<a class="headerlink" href="#file-open-close" title="Permalink to this heading"></a></h4>
<p>There will be interfaces for opening and closing files for reading and writing.
For the file open, a file id will be returned.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="c1">/// Opens a file for reading or writing, returns an error code.</span>
<span class="w">   </span><span class="c1">/// If the IOFileFormat argument is `default`, the default</span>
<span class="w">   </span><span class="c1">/// format from IOEnv will be used. `ifexists` will be ignored for</span>
<span class="w">   </span><span class="c1">/// reads.</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">IOFileOpen</span><span class="p">(</span><span class="kt">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">fileID</span><span class="p">,</span><span class="w"> </span><span class="c1">/// returned fileID for this file</span>
<span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w">  </span><span class="c1">/// name of file to open</span>
<span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="n">IOEnv</span><span class="o">&amp;</span><span class="w"> </span><span class="n">myEnv</span><span class="p">,</span><span class="w">          </span><span class="c1">/// overall IO environment</span>
<span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="n">IOMode</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w">           </span><span class="c1">/// mode (read or write)</span>
<span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="n">IOPrecision</span><span class="w"> </span><span class="n">precision</span><span class="p">,</span><span class="w"> </span><span class="c1">/// precision of floats</span>
<span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="n">IOIfExists</span><span class="w"> </span><span class="n">ifexists</span><span class="p">,</span><span class="w">   </span><span class="c1">/// behavior if file exists</span>
<span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="n">IOFileFormat</span><span class="w"> </span><span class="n">format</span><span class="p">,</span><span class="w">   </span><span class="c1">/// file format</span>
<span class="w">                 </span><span class="p">);</span>

<span class="w">   </span><span class="c1">/// closes an open file using the fileID, returns an error code</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="nf">IOFileClose</span><span class="p">(</span><span class="kt">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">fileID</span><span class="w">  </span><span class="c1">/// ID of the file to be closed</span>
<span class="w">                  </span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="write-operations">
<h4>4.2.3 Write operations<a class="headerlink" href="#write-operations" title="Permalink to this heading"></a></h4>
<p>Because the IOStreams and metadata manager have aggregated all
metadata, dims and pointers to data arrays, a file can be written
with a single call using the aggregated data from the IOStream:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="c1">/// writes all data associated with the file</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="nf">IOWrite</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">fileID</span><span class="p">,</span><span class="w"> </span><span class="c1">/// id for the open file</span>
<span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">IOField</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">contents</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="read-operations">
<h4>4.2.4 Read operations<a class="headerlink" href="#read-operations" title="Permalink to this heading"></a></h4>
<p>Unlike the write function, not all data within a file may need to
be read, so we read each field individually:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="c1">/// reads a field the file</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="nf">IORead</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">fileID</span><span class="p">,</span><span class="w"> </span><span class="c1">/// id for the open file</span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">IOField</span><span class="o">&gt;</span><span class="w"> </span><span class="n">field</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="defining-io-fields">
<h4>4.2.5 Defining IO fields<a class="headerlink" href="#defining-io-fields" title="Permalink to this heading"></a></h4>
<p>Each field meant to be read or written should be defined, typically
at the same time a module defines the associated metadata. The IOField
is then constructed first with a pointer to the Metadata:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="c1">/// IOField constructor</span>
<span class="w">   </span><span class="n">IOField</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Metadata</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fieldMeta</span><span class="p">);</span>
</pre></div>
</div>
<p>Then a pointer to the array is attached using an attach function
(aliased to the various array types):</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="c1">/// IOField attach data</span>
<span class="w">   </span><span class="n">IOField</span><span class="o">::</span><span class="n">attachData</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Array1DI4</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">   </span><span class="p">[</span><span class="n">replicate</span><span class="w"> </span><span class="n">generic</span><span class="w"> </span><span class="n">interface</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="n">types</span><span class="p">]</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="verification-and-testing">
<h2>5 Verification and Testing<a class="headerlink" href="#verification-and-testing" title="Permalink to this heading"></a></h2>
<section id="test-via-iostreams">
<h3>5.1 Test via IOStreams<a class="headerlink" href="#test-via-iostreams" title="Permalink to this heading"></a></h3>
<p>Because the functions here are only accessed via the IOStreams interfaces,
the testing of these routines will be part of the IOStreams unit test.</p>
<ul class="simple">
<li><p>tests requirement 2.1-2.9</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Metadata.html" class="btn btn-neutral float-left" title="Metadata" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="IOStreams.html" class="btn btn-neutral float-right" title="IOStreams" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Energy Exascale Earth System Model Project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>